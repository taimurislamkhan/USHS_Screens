<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./vars.css">
  <link rel="stylesheet" href="./style.css">
  
  <style>
   a,
   button,
   input,
   select,
   h1,
   h2,
   h3,
   h4,
   h5,
   * {
       box-sizing: border-box;
       margin: 0;
       padding: 0;
       border: none;
       text-decoration: none;
       background: none;
   
       -webkit-font-smoothing: antialiased;
   }
   
   menu, ol, ul {
       list-style-type: none;
       margin: 0;
       padding: 0;
   }
   </style>
  <title>USHS Screens</title>
</head>
<body>
  <div id="app-container"></div>
  
  <script>
    // Global WebSocket connection - maintained across navigation
    let ws = null;
    let isRunning = false; // Global state for toggle switch
    let currentProgressStates = {}; // Store progress states
    let currentTipStates = {}; // Store tip states
    
    // Initialize WebSocket connection once
    function initWebSocket() {
      ws = new WebSocket('ws://localhost:8080');
      
      ws.onopen = () => {
        console.log('WebSocket connected');
      };
      
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log('WebSocket message received:', data);
          
          // Store states globally
          if (data.type === 'update_progress_states') {
            currentProgressStates = data.states;
          } else if (data.type === 'update_tip_state') {
            currentTipStates[data.tipNumber] = data.isActive;
          }
          
          // Dispatch events for current page to handle
          const customEvent = new CustomEvent(data.type, { detail: data });
          window.dispatchEvent(customEvent);
        } catch (error) {
          console.error('Error parsing WebSocket message:', error);
        }
      };
      
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
      
      ws.onclose = () => {
        console.log('WebSocket disconnected, attempting to reconnect...');
        setTimeout(initWebSocket, 2000); // Reconnect after 2 seconds
      };
    }
    
    // Start WebSocket connection
    initWebSocket();
    
    // Current page tracker
    let currentPage = 'home';
    
    // Global navigation function - now loads content dynamically
    async function navigateToPage(relativePath) {
      console.log('Navigating to:', relativePath);
      
      try {
        let contentUrl;
        
        // Determine which content to load
        if (relativePath === 'index.html' || relativePath === '') {
          contentUrl = 'HomeScreen.html';
          currentPage = 'home';
        } else {
          contentUrl = relativePath;
          currentPage = relativePath.split('/').pop().replace('.html', '');
        }
        
        // Fetch the content
        const response = await fetch(contentUrl + '?t=' + new Date().getTime());
        const html = await response.text();
        
        // Update the container with new content
        document.getElementById('app-container').innerHTML = html;
        
        // Reinitialize page-specific functionality
        initializePage();
        
      } catch (error) {
        console.error('Navigation error:', error);
      }
    }
    
    // Initialize page-specific functionality
    function initializePage() {
      // Add click styling to navigation buttons
      const style = document.createElement('style');
      style.textContent = `
        .button-control-in-active, .button-home, .button-settings-in-active {
          cursor: pointer;
          transition: opacity 0.2s ease;
        }
        .button-control-in-active:hover, .button-home:hover, .button-settings-in-active:hover {
          opacity: 0.8;
        }
        
        .label-tip-active, .label-tip-in-active {
          cursor: pointer;
          transition: all 0.2s ease;
        }
        .label-tip-active:hover, .label-tip-in-active:hover {
          opacity: 0.8;
          transform: scale(1.02);
        }
      `;
      
      // Remove old style if exists
      const oldStyle = document.getElementById('navigation-styles');
      if (oldStyle) oldStyle.remove();
      
      style.id = 'navigation-styles';
      document.head.appendChild(style);
      
      // Reattach event listeners based on current page
      if (currentPage === 'home') {
        initializeHomePage();
      }
      
      // Setup navigation button clicks
      setupNavigationButtons();
    }
    
    // Initialize home page specific functionality
    function initializeHomePage() {
      // Restore current states
      if (Object.keys(currentProgressStates).length > 0) {
        updateProgressStates(currentProgressStates);
      }
      
      // Restore tip states
      Object.entries(currentTipStates).forEach(([tipNumber, isActive]) => {
        const event = new CustomEvent('update-tip-state', {
          detail: { tipNumber: parseInt(tipNumber), isActive }
        });
        window.dispatchEvent(event);
      });
      
      // Setup toggle switch
      const toggleSwitch = document.getElementById('toggle-switch');
      if (toggleSwitch) {
        // Restore toggle state
        if (isRunning) {
          toggleSwitch.className = 'toggle-switch-red';
          const toggleText = document.getElementById('toggle-text');
          if (toggleText) toggleText.textContent = 'Stop';
        }
      }
      
      // Setup listeners
      setupHomeListeners();
    }
    
    // Progress state management functions
    function updateProgressStates(states) {
      const progressItems = ["home", "work_position", "encoder_zero", "heat", "cool", "cycle_complete"];
      
      progressItems.forEach((item, index) => {
        const state = states[item] || 'inactive';
        
        // Get selectors for each element
        const ellipseSelector = index < 3 ? 
          '.progress-bar-vertical-check-' + (index + 1) + ' .ellipse-1' :
          '.progress-bar-vertical-un-check-' + (index - 2) + ' .ellipse-1';
        
        const labelSelector = index < 3 ?
          (index === 0 ? '.label-successfull' : '.label-successfull' + (index + 1)) :
          '.label-successfull-unchecked-' + (index - 2);
        
        const ellipse = document.querySelector(ellipseSelector);
        const label = document.querySelector(labelSelector);
        
        if (ellipse) {
          // Remove all state classes
          ellipse.classList.remove('ellipse-active', 'ellipse-completed', 'ellipse-inactive');
          
          // Add appropriate class based on state
          switch(state) {
            case 'active':
              ellipse.classList.add('ellipse-active');
              break;
            case 'completed':
              ellipse.classList.add('ellipse-completed');
              break;
            default:
              ellipse.classList.add('ellipse-inactive');
          }
        }
        
        if (label) {
          // Remove all state classes
          label.classList.remove('label-active', 'label-completed', 'label-inactive');
          
          // Add appropriate class based on state
          switch(state) {
            case 'active':
              label.classList.add('label-active');
              break;
            case 'completed':
              label.classList.add('label-completed');
              break;
            default:
              label.classList.add('label-inactive');
          }
        }
      });
    }
    
    // Toggle switch functionality
    function toggleSwitch() {
      const toggleSwitch = document.getElementById('toggle-switch');
      const toggleText = document.getElementById('toggle-text');
      
      isRunning = !isRunning;
      
      if (isRunning) {
        // Switch to running state (red)
        toggleSwitch.className = 'toggle-switch-red';
        toggleText.textContent = 'Stop';
        
        // Send start command to Python script
        if (window.electronAPI) {
          window.electronAPI.sendToPython({
            type: 'toggle_state',
            state: 'start'
          });
        }
      } else {
        // Switch to stopped state (blue)
        toggleSwitch.className = 'toggle-switch-blue';
        toggleText.textContent = 'Start';
        
        // Send stop command to Python script
        if (window.electronAPI) {
          window.electronAPI.sendToPython({
            type: 'toggle_state',
            state: 'stop'
          });
        }
      }
    }
    
    // Setup navigation button clicks
    function setupNavigationButtons() {
      document.addEventListener('click', function(event) {
        // Handle toggle switch
        const toggleSwitchElement = event.target.closest('#toggle-switch');
        if (toggleSwitchElement) {
          toggleSwitch();
          return;
        }
        
        // Handle navigation buttons
        const controlButton = event.target.closest('.button-control-in-active');
        const settingsButton = event.target.closest('.button-settings-in-active');
        const homeButton = event.target.closest('.button-home');
        
        if (controlButton) {
          navigateToPage('admin/manual_controls/index.html');
        } else if (settingsButton) {
          navigateToPage('settings/work_position/index.html');
        } else if (homeButton) {
          navigateToPage('index.html');
        }
        
        // Handle tip clicks
        const tipContainer = event.target.closest('.tip-display-active, .tip-display-in-active');
        if (tipContainer) {
          toggleTip(tipContainer);
        }
      });
    }
    
    // Setup home page listeners
    function setupHomeListeners() {
      // Listen for progress states updates
      window.addEventListener('update_progress_states', (event) => {
        console.log('Received progress states update:', event.detail.states);
        updateProgressStates(event.detail.states);
      });
      
      // Listen for progress text updates
      window.addEventListener('update_progress_text', (event) => {
        const progressTextElement = document.getElementById('home-cycle-progress-text');
        if (progressTextElement) {
          progressTextElement.textContent = event.detail.text;
        }
      });
      
      // Listen for tip state updates
      window.addEventListener('update-tip-state', (event) => {
        const tipNumber = event.detail.tipNumber;
        const isActive = event.detail.isActive;
        
        // Find the tip container
        const tipContainers = document.querySelectorAll('.tip-display-active, .tip-display-in-active');
        const tipContainer = Array.from(tipContainers).find(container => {
          const numberElement = container.querySelector('.text-suisse-242, .text-suisse-244');
          return numberElement && numberElement.textContent.trim() === tipNumber.toString();
        });
        
        if (tipContainer) {
          setTipState(tipContainer, isActive);
        }
      });
      
      // Listen for DOM element updates
      if (window.electronAPI) {
        window.electronAPI.onUpdateElement((data) => {
          const element = document.getElementById(data.elementId);
          if (element) {
            if (data.property === 'textContent') {
              element.textContent = data.value;
            } else if (data.property === 'value') {
              element.value = data.value;
            } else if (data.property === 'class') {
              element.className = data.value;
            } else if (data.property.startsWith('style.')) {
              const styleProp = data.property.substring(6);
              element.style[styleProp] = data.value;
            }
          }
        });
      }
    }
    
    // Tip toggle functionality
    function toggleTip(tipContainer) {
      const currentlyActive = tipContainer.classList.contains('tip-display-active');
      const tipNumberElement = tipContainer.querySelector('.text-suisse-242, .text-suisse-244');
      const tipNumber = tipNumberElement ? parseInt(tipNumberElement.textContent.trim()) : null;
      
      if (tipNumber) {
        // Update global state
        currentTipStates[tipNumber] = !currentlyActive;
        
        // Send to Python script
        if (window.electronAPI) {
          window.electronAPI.sendToPython({
            type: 'tip_toggle',
            tip_number: tipNumber,
            active: !currentlyActive
          });
        }
        
        // Update UI
        setTipState(tipContainer, !currentlyActive);
      }
    }
    
    // Function to set tip state
    function setTipState(tipContainer, isActive) {
      const currentlyActive = tipContainer.classList.contains('tip-display-active');
      
      if (isActive && !currentlyActive) {
        // Switch to active
        tipContainer.classList.remove('tip-display-in-active');
        tipContainer.classList.add('tip-display-active');
        
        // Update label classes
        const labelInactive = tipContainer.querySelector('.label-in-active');
        const labelTipInactive = tipContainer.querySelector('.label-tip-in-active');
        
        if (labelInactive) {
          labelInactive.classList.remove('label-in-active');
          labelInactive.classList.add('label-active');
        }
        
        if (labelTipInactive) {
          labelTipInactive.classList.remove('label-tip-in-active');
          labelTipInactive.classList.add('label-tip-active');
        }
        
        // Update tip number text color
        const tipNumberText = tipContainer.querySelector('.text-suisse-244');
        if (tipNumberText) {
          tipNumberText.classList.remove('text-suisse-244');
          tipNumberText.classList.add('text-suisse-242');
        }
        
        // Update text content
        const inactiveText = tipContainer.querySelector('.label-tip-active .text-suisse-243');
        if (inactiveText) {
          inactiveText.textContent = 'Active';
        }
        
        // Update ellipse
        const ellipse2 = tipContainer.querySelector('.ellipse2');
        if (ellipse2) {
          ellipse2.classList.remove('ellipse2');
          ellipse2.classList.add('ellipse');
        }
        
        // Update joules and distance text colors
        const joulesText = tipContainer.querySelector('._0-j');
        const distanceText = tipContainer.querySelector('.home-tip-distance-in-active');
        
        if (joulesText) {
          joulesText.classList.remove('_0-j');
          joulesText.classList.add('text-suisse-322');
        }
        
        if (distanceText) {
          distanceText.classList.remove('home-tip-distance-in-active');
          distanceText.classList.add('home-tip-distance-active');
        }
        
        // Update progress bar
        const progressBar = tipContainer.querySelector('.progress-bar-in-active');
        if (progressBar) {
          progressBar.classList.remove('progress-bar-in-active');
          progressBar.classList.add('progress-bar-active');
          
          // Update all progress bar fill elements
          const fills = progressBar.querySelectorAll('[class*="progress-bar-in-active-fill"]');
          fills.forEach((fill, index) => {
            const currentClass = fill.className;
            const newClass = currentClass.replace('progress-bar-in-active-fill', 'progress-bar-active-fill');
            fill.className = newClass;
          });
        }
        
      } else if (!isActive && currentlyActive) {
        // Switch to inactive
        tipContainer.classList.remove('tip-display-active');
        tipContainer.classList.add('tip-display-in-active');
        
        // Update label classes
        const labelActive = tipContainer.querySelector('.label-active');
        const labelTipActive = tipContainer.querySelector('.label-tip-active');
        
        if (labelActive) {
          labelActive.classList.remove('label-active');
          labelActive.classList.add('label-in-active');
        }
        
        if (labelTipActive) {
          labelTipActive.classList.remove('label-tip-active');
          labelTipActive.classList.add('label-tip-in-active');
        }
        
        // Update tip number text color
        const tipNumberText = tipContainer.querySelector('.text-suisse-242');
        if (tipNumberText) {
          tipNumberText.classList.remove('text-suisse-242');
          tipNumberText.classList.add('text-suisse-244');
        }
        
        // Update text content
        const activeText = tipContainer.querySelector('.label-tip-in-active .text-suisse-243');
        if (activeText) {
          activeText.textContent = 'In-Active';
        }
        
        // Update ellipse
        const ellipse = tipContainer.querySelector('.ellipse');
        if (ellipse && !ellipse.classList.contains('ellipse-1')) {
          ellipse.classList.remove('ellipse');
          ellipse.classList.add('ellipse2');
        }
        
        // Update joules and distance text colors
        const joulesText = tipContainer.querySelector('.text-suisse-322');
        const distanceText = tipContainer.querySelector('.home-tip-distance-active');
        
        if (joulesText) {
          joulesText.classList.remove('text-suisse-322');
          joulesText.classList.add('_0-j');
        }
        
        if (distanceText) {
          distanceText.classList.remove('home-tip-distance-active');
          distanceText.classList.add('home-tip-distance-in-active');
        }
        
        // Update progress bar
        const progressBar = tipContainer.querySelector('.progress-bar-active');
        if (progressBar) {
          progressBar.classList.remove('progress-bar-active');
          progressBar.classList.add('progress-bar-in-active');
          
          // Update all progress bar fill elements
          const fills = progressBar.querySelectorAll('[class*="progress-bar-active-fill"]');
          fills.forEach((fill, index) => {
            const currentClass = fill.className;
            const newClass = currentClass.replace('progress-bar-active-fill', 'progress-bar-in-active-fill');
            fill.className = newClass;
          });
        }
      }
    }
    
    // Initial load - load home screen
    navigateToPage('index.html');
  </script>
</body>
</html>