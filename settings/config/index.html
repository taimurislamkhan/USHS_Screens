<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./vars.css">
  <link rel="stylesheet" href="./style.css">
  
  
  <style>
   a,
   button,
   input,
   select,
   h1,
   h2,
   h3,
   h4,
   h5,
   * {
       box-sizing: border-box;
       margin: 0;
       padding: 0;
       border: none;
       text-decoration: none;
       background: none;
   
       -webkit-font-smoothing: antialiased;
   }
   
   menu, ol, ul {
       list-style-type: none;
       margin: 0;
       padding: 0;
   }
   </style>
  <title>Configuration</title>
</head>
<body>
  <div class="settings-config">
    <div class="frame-160">
      <div class="button-home" onclick="navigateToPage('../../index.html')">
        <div class="rectangle-4"></div>
        <div class="frame">
          <img class="svg-repo-icon-carrier" src="svg-repo-icon-carrier0.svg" />
        </div>
      </div>
      <div class="frame-183">
        <div class="button-control">
          <div class="frame">
            <img
              class="svg-repo-icon-carrier2"
              src="svg-repo-icon-carrier1.svg"
            />
          </div>
        </div>
        <div class="button-settings" onclick="navigateToPage('../../admin/manual_controls/index.html')">
          <div class="rectangle-42"></div>
          <div class="frame2">
            <img
              class="svg-repo-icon-carrier3"
              src="svg-repo-icon-carrier2.svg"
            />
          </div>
        </div>
      </div>
    </div>
    <div class="frame-42">
      <div class="frame-197">
        <div class="frame-161">
          <div class="frame-136">
            <div class="weld-time">Weld Time</div>
            <div class="frame-196">
              <div class="frame-5">
                <div class="weld-time2">0 sec</div>
              </div>
              <div class="frame-1832">
                <div class="weld-time-minus">
                  <div class="rectangle-43"></div>
                  <div class="frame3">
                    <img
                      class="svg-repo-icon-carrier4"
                      src="svg-repo-icon-carrier3.svg"
                    />
                  </div>
                </div>
                <div class="weld-time-plus">
                  <div class="frame4">
                    <img
                      class="svg-repo-icon-carrier5"
                      src="svg-repo-icon-carrier4.svg"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="frame-140">
            <div class="pulse-energy">Pulse Energy</div>
            <div class="frame-196">
              <div class="frame-5">
                <div class="pulse-energy2">10 J</div>
              </div>
              <div class="frame-1832">
                <div class="pulse-energy-minus">
                  <div class="rectangle-43"></div>
                  <div class="frame3">
                    <img
                      class="svg-repo-icon-carrier6"
                      src="svg-repo-icon-carrier5.svg"
                    />
                  </div>
                </div>
                <div class="pulse-energy-plus">
                  <div class="frame5">
                    <img
                      class="svg-repo-icon-carrier7"
                      src="svg-repo-icon-carrier6.svg"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="frame-141">
            <div class="cool-time">Cool Time</div>
            <div class="frame-196">
              <div class="frame-5">
                <div class="cool-time2">0 sec</div>
              </div>
              <div class="frame-1832">
                <div class="cool-time-minus">
                  <div class="rectangle-43"></div>
                  <div class="frame3">
                    <img
                      class="svg-repo-icon-carrier8"
                      src="svg-repo-icon-carrier7.svg"
                    />
                  </div>
                </div>
                <div class="cool-time-plus">
                  <div class="frame6">
                    <img
                      class="svg-repo-icon-carrier9"
                      src="svg-repo-icon-carrier8.svg"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="frame-217">
          <div class="frame-136">
            <div class="presence-height">Presence Height</div>
            <div class="frame-196">
              <div class="frame-5">
                <div class="presence-height2">0 mm</div>
              </div>
              <div class="frame-1832">
                <div class="presence-height-minus">
                  <div class="rectangle-43"></div>
                  <div class="frame3">
                    <img
                      class="svg-repo-icon-carrier10"
                      src="svg-repo-icon-carrier9.svg"
                    />
                  </div>
                </div>
                <div class="presence-height-plus">
                  <div class="frame4">
                    <img
                      class="svg-repo-icon-carrier11"
                      src="svg-repo-icon-carrier10.svg"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="frame-140">
            <div class="boss-tolerance">Boss Tolerance -</div>
            <div class="frame-196">
              <div class="frame-5">
                <div class="boss-tolerance2">0.0 mm</div>
              </div>
              <div class="frame-1832">
                <div class="boss-tolerance-minus">
                  <div class="rectangle-43"></div>
                  <div class="frame3">
                    <img
                      class="svg-repo-icon-carrier12"
                      src="svg-repo-icon-carrier11.svg"
                    />
                  </div>
                </div>
                <div class="boss-tolerance-plus">
                  <div class="frame5">
                    <img
                      class="svg-repo-icon-carrier13"
                      src="svg-repo-icon-carrier12.svg"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="frame-141">
            <div class="boss-tolerance">Boss Tolerance +</div>
            <div class="frame-196">
              <div class="frame-5">
                <div class="boss-tolerance2">0.5 mm</div>
              </div>
              <div class="frame-1832">
                <div class="boss-tolerance-minus">
                  <div class="rectangle-43"></div>
                  <div class="frame3">
                    <img
                      class="svg-repo-icon-carrier14"
                      src="svg-repo-icon-carrier13.svg"
                    />
                  </div>
                </div>
                <div class="boss-tolerance-plus">
                  <div class="frame6">
                    <img
                      class="svg-repo-icon-carrier15"
                      src="svg-repo-icon-carrier14.svg"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="weld-cycle">Weld Cycle</div>
      <div class="boss-insert-detection">Boss/Insert Detection</div>
    </div>
    <div class="navigation-tabs">
      <div class="tab-inactive" onclick="navigateToPage('../work_position/index.html')">
        <div class="tab-text-inactive">Work Position</div>
      </div>
      <div class="tab-inactive" onclick="navigateToPage('../heating/index.html')">
        <div class="tab-text-inactive">Heating</div>
      </div>
      <div class="tab-active">
        <div class="tab-text-active">Configuration</div>
      </div>
    </div>
    <img class="image-3" src="image-30.png" />
  </div>
  
  <script>
    function navigateToPage(relativePath) {
      window.location.href = relativePath;
    }

    // IDs for value spans to update
    const configIds = {
      weld_time: '.weld-time2',
      pulse_energy: '.pulse-energy2',
      cool_time: '.cool-time2',
      presence_height: '.presence-height2',
      boss_tolerance_minus: '.frame-217 .frame-140 .boss-tolerance2',
      boss_tolerance_plus: '.frame-217 .frame-141 .boss-tolerance2'
    };

    // Local state
    const configState = {
      weld_time: 0,
      pulse_energy: 10,
      cool_time: 0,
      presence_height: 0,
      boss_tolerance_minus: 0,
      boss_tolerance_plus: 0
    };

    function updateDisplay() {
      const weld = document.querySelector(configIds.weld_time);
      if (weld) weld.textContent = `${configState.weld_time.toFixed(2)} sec`;

      const pe = document.querySelector(configIds.pulse_energy);
      if (pe) pe.textContent = `${configState.pulse_energy.toFixed(1)} J`;

      const cool = document.querySelector(configIds.cool_time);
      if (cool) cool.textContent = `${configState.cool_time.toFixed(2)} sec`;

      const ph = document.querySelector(configIds.presence_height);
      if (ph) ph.textContent = `${configState.presence_height.toFixed(3)} mm`;

      // The two boss tolerance entries share class names; use nearest selectors already mapped
      const btMinus = document.querySelector(configIds.boss_tolerance_minus);
      if (btMinus) btMinus.textContent = `${configState.boss_tolerance_minus.toFixed(3)} mm`;

      const btPlus = document.querySelector(configIds.boss_tolerance_plus);
      if (btPlus) btPlus.textContent = `${configState.boss_tolerance_plus.toFixed(3)} mm`;
    }

    async function loadConfiguration() {
      try {
        const response = await window.electronAPI.sendMessage('read_configuration');
        if (response && response.configuration) {
          Object.assign(configState, response.configuration);
          updateDisplay();
        }
      } catch (e) {
        console.error('Error loading configuration:', e);
      }
    }

    async function saveConfigKey(key) {
      try {
        await window.electronAPI.sendMessage('update_configuration', { key, value: configState[key] });
        // Send to Python for Modbus write
        window.electronAPI.sendToPython({ type: 'update_configuration', key, value: configState[key] });
      } catch (e) {
        console.error('Error saving configuration:', e);
      }
    }

    function wireButton(selectorMinus, selectorPlus, key, step, min = -Infinity, max = Infinity) {
      const minus = document.querySelector(selectorMinus);
      const plus = document.querySelector(selectorPlus);

      // Helper to apply change with clamping and update
      const applyChange = (delta) => {
        const next = Math.max(min, Math.min(max, (configState[key] + delta)));
        if (next === configState[key]) return false;
        configState[key] = next;
        updateDisplay();
        return true;
      };

      // Press-and-hold with acceleration
      const addHoldBehavior = (el, deltaSign) => {
        if (!el) return;

        let holdTimeoutId = null;
        let repeatIntervalId = null;
        let holdBegan = false;
        let currentIntervalMs = 200; // starting repeat interval
        const minIntervalMs = 40;    // fastest repeat
        const accelStepMs = 20;      // accelerate by reducing interval
        const holdStartDelayMs = 350; // delay before repeats start

        const clearTimers = () => {
          if (holdTimeoutId) { clearTimeout(holdTimeoutId); holdTimeoutId = null; }
          if (repeatIntervalId) { clearInterval(repeatIntervalId); repeatIntervalId = null; }
        };

        const stepOnce = () => {
          const changed = applyChange(deltaSign * step);
          // Save on every step; fire-and-forget
          if (changed) { saveConfigKey(key); }
          // accelerate
          currentIntervalMs = Math.max(minIntervalMs, currentIntervalMs - accelStepMs);
          clearInterval(repeatIntervalId);
          repeatIntervalId = setInterval(stepOnce, currentIntervalMs);
        };

        const startHold = () => {
          clearTimers();
          holdBegan = false;
          currentIntervalMs = 200;
          holdTimeoutId = setTimeout(() => {
            holdBegan = true;
            // first repeat
            stepOnce();
          }, holdStartDelayMs);
        };

        const endHold = (e) => {
          clearTimers();
          if (holdBegan) {
            // suppress the ensuing click after a hold
            if (e) { e.preventDefault(); e.stopPropagation(); }
            // reset flag shortly after to allow future clicks
            setTimeout(() => { holdBegan = false; }, 0);
          }
        };

        el.addEventListener('mousedown', startHold);
        el.addEventListener('touchstart', startHold, { passive: true });
        ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach(evt => {
          el.addEventListener(evt, endHold, { passive: true });
        });

        // Normal click = single step
        el.addEventListener('click', async (e) => {
          if (holdBegan) { e.preventDefault(); e.stopPropagation(); holdBegan = false; return; }
          if (applyChange(deltaSign * step)) {
            await saveConfigKey(key);
          }
        });
      };

      addHoldBehavior(minus, -1);
      addHoldBehavior(plus, +1);
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Load saved config from JSON
      loadConfiguration();

      // Wire buttons with appropriate steps and bounds
      wireButton('.weld-time-minus', '.weld-time-plus', 'weld_time', 0.01, 0, 999);
      wireButton('.pulse-energy-minus', '.pulse-energy-plus', 'pulse_energy', 0.1, 0, 9999);
      wireButton('.cool-time-minus', '.cool-time-plus', 'cool_time', 0.01, 0, 999);
      wireButton('.presence-height-minus', '.presence-height-plus', 'presence_height', 0.001, 0, 9999);
      wireButton('.frame-217 .frame-140 .boss-tolerance-minus', '.frame-217 .frame-140 .boss-tolerance-plus', 'boss_tolerance_minus', 0.001, -50, 50);
      wireButton('.frame-217 .frame-141 .boss-tolerance-minus', '.frame-217 .frame-141 .boss-tolerance-plus', 'boss_tolerance_plus', 0.001, -50, 50);

      // Add click styling to navigation buttons
      const style = document.createElement('style');
      style.textContent = `
        .tab-inactive, .button-home, .button-settings {
          cursor: pointer;
          transition: opacity 0.2s ease;
        }
        .tab-inactive:hover, .button-home:hover, .button-settings:hover {
          opacity: 0.8;
        }
      `;
      document.head.appendChild(style);
    });
  </script>
</body>
</html>